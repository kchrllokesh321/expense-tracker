name: Build APK & Deploy to MicroK8s

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: lokesh86186
  IMAGE_NAME: react
  KUBE_SERVER: 45.129.86.68
  DEPLOYMENT_FILE: deployment.yaml
  SERVICE_FILE: service.yaml
  SECRET_FILE: kube-secret.yaml
  APP_LABEL: expense-app
  DEPLOYMENT_NAME: expense-app-deployment

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 3Ô∏è‚É£ Ensure SDK path exists for Gradle
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties

    # 4Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y openjdk-17-jdk gradle
        npm install -g yarn
        yarn install

    # 5Ô∏è‚É£ Optional: Force Gradle version
    - name: Use Gradle 8.5
      run: |
        cd android
        chmod +x gradlew
        ./gradlew wrapper --gradle-version 8.5

    # 6Ô∏è‚É£ Sync Capacitor plugins (fix missing cordova.variables.gradle)
    - name: Sync Capacitor Plugins
      run: |
        yarn install
        npx cap sync android

    # 7Ô∏è‚É£ Build Android APK
    - name: Build Android APK
      run: |
        cd android
        chmod +x gradlew                 # Fix permission
        ./gradlew clean                  # Clean old builds
        ./gradlew assembleRelease --no-daemon --warning-mode all
        cd ..
        echo "APK_PATH=$(find android/app/build/outputs/apk/release -name '*.apk' | head -n 1)" >> $GITHUB_ENV

    # 8Ô∏è‚É£ Upload APK as artifact
    - name: Upload APK to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: ${{ env.APK_PATH }}

    # 9Ô∏è‚É£ Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # üîü Build & push Docker image (tagged with commit ID)
    - name: Build and Push Docker image
      run: |
        COMMIT_ID=$(echo $GITHUB_SHA | cut -c1-7)
        IMAGE_TAG=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$COMMIT_ID
        docker build -t $IMAGE_TAG .
        docker push $IMAGE_TAG
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    # 11Ô∏è‚É£ Setup SSH key
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # 12Ô∏è‚É£ Add server to known hosts
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.KUBE_SERVER }} >> ~/.ssh/known_hosts

    # 13Ô∏è‚É£ Copy manifests & APK to server
    - name: Copy manifests & APK to server
      run: |
        scp -o StrictHostKeyChecking=no \
          ${{ env.SECRET_FILE }} ${{ env.DEPLOYMENT_FILE }} ${{ env.SERVICE_FILE }} \
          ${{ env.APK_PATH }} \
          ubuntu@${{ env.KUBE_SERVER }}:/tmp/

    # 14Ô∏è‚É£ Deploy to MicroK8s & store APK
    - name: Deploy to MicroK8s
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ env.KUBE_SERVER }} << 'EOF'
          set -e
          echo "üöÄ Starting MicroK8s deployment..."
          mkdir -p ~/apks
          mv /tmp/*.apk ~/apks/

          echo "üì¶ Applying Kubernetes resources..."
          microk8s kubectl apply -f /tmp/kube-secret.yaml
          microk8s kubectl apply -f /tmp/deployment.yaml
          microk8s kubectl apply -f /tmp/service.yaml

          echo "‚è≥ Waiting for deployment rollout..."
          microk8s kubectl rollout status deployment/expense-app-deployment --timeout=300s

          echo "‚úÖ Listing resources..."
          microk8s kubectl get pods -l app=expense-app
          microk8s kubectl get svc

          echo "üßπ Cleaning up temp files..."
          rm -f /tmp/*.yaml
          echo "üì≤ APK saved at: /home/ubuntu/apks/"
        EOF

    # 15Ô∏è‚É£ Summary
    - name: Deployment Summary
      run: |
        echo "üöÄ Deployment complete!"
        echo "üì¶ Image: $IMAGE_TAG"
        echo "üéØ Server: ${{ env.KUBE_SERVER }}"
        echo "üì≤ APK stored on server at: /home/ubuntu/apks/"
        echo "‚û°Ô∏è To download to your desktop:"
        echo "scp ubuntu@${{ env.KUBE_SERVER }}:/home/ubuntu/apks/*.apk ."
