name: Build, Deploy APK & MicroK8s

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_USERNAME: lokesh86186
  IMAGE_NAME: expense-app
  KUBE_SERVER: 45.129.86.68
  DEPLOYMENT_FILE: deployment.yaml
  SERVICE_FILE: service.yaml
  SECRET_FILE: kube-secret.yaml
  APP_LABEL: expense-app
  DEPLOYMENT_NAME: expense-app-deployment
  ANDROID_HOME: /usr/local/lib/android/sdk
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    # 3Ô∏è‚É£ Setup Java 17
    - name: Setup Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 4Ô∏è‚É£ Force Java 17 globally for Gradle
    - name: Force Java 17 for Gradle
      run: java -version

    # 5Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: yarn install

    # 6Ô∏è‚É£ Build React web assets
    - name: Build React web assets
      run: yarn build

    # 7Ô∏è‚É£ Capacitor sync Android
    - name: Capacitor sync
      run: |
        chmod +x android/gradlew
        npx cap sync android

    # 8Ô∏è‚É£ Clean Gradle caches and build APK
    - name: Build APK
      run: |
        cd android
        ./gradlew clean --no-daemon
        rm -rf ~/.gradle/caches/
        ./gradlew assembleRelease --no-daemon --warning-mode all
        cd ..
        # Save APK path and short SHA
        echo "APK_PATH=$(find android/app/build/outputs/apk/release -name '*.apk' | head -n 1)" >> $GITHUB_ENV
        echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

    # 9Ô∏è‚É£ Upload APK artifact
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: expense-app-apk-${{ env.SHORT_SHA }}
        path: ${{ env.APK_PATH }}

    # üîü Login to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 1Ô∏è‚É£1Ô∏è‚É£ Build and push Docker image with commit SHA
    - name: Build and push Docker image
      run: |
        docker build -t ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }} .
        docker push ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}

    # 1Ô∏è‚É£2Ô∏è‚É£ Setup SSH key for deployment
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # 1Ô∏è‚É£3Ô∏è‚É£ Add server to known hosts
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.KUBE_SERVER }} >> ~/.ssh/known_hosts

    # 1Ô∏è‚É£4Ô∏è‚É£ Deploy to MicroK8s
    - name: Deploy to MicroK8s
      run: |
        # Update image in deployment YAML
        sed -i "s|image:.*|image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}|g" ${{ env.DEPLOYMENT_FILE }}

        # Copy YAMLs to server
        scp -o StrictHostKeyChecking=no ${{ env.SECRET_FILE }} ${{ env.DEPLOYMENT_FILE }} ${{ env.SERVICE_FILE }} ubuntu@${{ env.KUBE_SERVER }}:/tmp/

        # Apply resources
        ssh -o StrictHostKeyChecking=no ubuntu@${{ env.KUBE_SERVER }} << 'EOF'
          echo "Applying Kubernetes manifests..."
          microk8s kubectl apply -f /tmp/kube-secret.yaml
          microk8s kubectl apply -f /tmp/deployment.yaml
          microk8s kubectl apply -f /tmp/service.yaml

          echo "Waiting for deployment rollout..."
          microk8s kubectl rollout status deployment/expense-app-deployment --timeout=300s

          echo "Listing pods and services..."
          microk8s kubectl get pods -l app=expense-app
          microk8s kubectl get svc expense-app-service

          echo "Cleaning up temporary files..."
          rm -f /tmp/kube-secret.yaml /tmp/deployment.yaml /tmp/service.yaml
        EOF

    # 1Ô∏è‚É£5Ô∏è‚É£ Deployment summary
    - name: Deployment Summary
      run: |
        echo "üöÄ Deployment completed successfully!"
        echo "üì¶ APK path: ${{ env.APK_PATH }}"
        echo "üì¶ Docker image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}"
        echo "üéØ MicroK8s server: ${{ env.KUBE_SERVER }}"
